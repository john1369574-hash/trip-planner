<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>æ—…éŠè¡Œç¨‹è¦åŠƒ</title>
    
    <!-- PWA è¨­å®š -->
    <link rel="manifest" href="manifest.json">
    <meta name="theme-color" content="#667eea">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="apple-mobile-web-app-title" content="è¡Œç¨‹è¦åŠƒ">
    <link rel="apple-touch-icon" href="icon-192.png">
    
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
    <style>
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        }
        .page {
            display: none;
        }
        .page.active {
            display: block;
        }
        .timeline-item {
            position: relative;
            padding-left: 40px;
            margin-bottom: 20px;
        }
        .timeline-item:before {
            content: '';
            position: absolute;
            left: 10px;
            top: 0;
            bottom: -20px;
            width: 2px;
            background: #3b82f6;
        }
        .timeline-item:last-child:before {
            display: none;
        }
        .timeline-dot {
            position: absolute;
            left: 0;
            top: 5px;
            width: 20px;
            height: 20px;
            border-radius: 50%;
            background: #3b82f6;
            border: 3px solid white;
            box-shadow: 0 0 0 2px #3b82f6;
        }
        .place-card {
            transition: all 0.3s;
        }
        .place-card:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(0,0,0,0.15);
        }
        .emoji-btn {
            font-size: 24px;
            cursor: pointer;
            padding: 8px;
            border-radius: 8px;
            transition: background 0.2s;
        }
        .emoji-btn:hover {
            background: #f3f4f6;
        }
        #capture-area {
            background: white;
            padding: 30px;
            max-width: 800px;
            margin: 0 auto;
        }
        .gradient-bg {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        }
    </style>
</head>
<body class="bg-gray-50">

    <!-- è¡Œç¨‹åˆ—è¡¨é  -->
    <div id="listPage" class="page active">
        <div class="gradient-bg text-white py-8 px-4">
            <div class="max-w-4xl mx-auto">
                <h1 class="text-3xl font-bold mb-2">ğŸ—ºï¸ æˆ‘çš„æ—…è¡Œè¨ˆç•«</h1>
                <p class="text-blue-100">è¦åŠƒä½ çš„å®Œç¾æ—…ç¨‹</p>
            </div>
        </div>
        
        <div class="max-w-4xl mx-auto px-4 py-8">
            <button onclick="showCreateTrip()" class="w-full bg-blue-500 hover:bg-blue-600 text-white font-semibold py-4 px-6 rounded-lg shadow-lg mb-6 transition">
                â• å»ºç«‹æ–°è¡Œç¨‹
            </button>
            
            <div id="tripsList" class="space-y-4">
                <!-- è¡Œç¨‹åˆ—è¡¨æœƒé¡¯ç¤ºåœ¨é€™è£¡ -->
            </div>
        </div>
    </div>

    <!-- å»ºç«‹è¡Œç¨‹é  -->
    <div id="createPage" class="page">
        <div class="gradient-bg text-white py-6 px-4">
            <div class="max-w-4xl mx-auto">
                <button onclick="showList()" class="text-white mb-4">â† è¿”å›</button>
                <h2 class="text-2xl font-bold">å»ºç«‹æ–°è¡Œç¨‹</h2>
            </div>
        </div>
        
        <div class="max-w-4xl mx-auto px-4 py-8">
            <div class="bg-white rounded-lg shadow-lg p-6 space-y-4">
                <div>
                    <label class="block text-gray-700 font-semibold mb-2">è¡Œç¨‹åç¨±</label>
                    <input type="text" id="tripTitle" placeholder="ä¾‹å¦‚ï¼šæ±äº¬äº”æ—¥éŠ" class="w-full border border-gray-300 rounded-lg px-4 py-3 focus:outline-none focus:ring-2 focus:ring-blue-500">
                </div>
                
                <div>
                    <label class="block text-gray-700 font-semibold mb-2">æ—…éŠå¤©æ•¸</label>
                    <input type="number" id="tripDays" min="1" max="30" value="3" class="w-full border border-gray-300 rounded-lg px-4 py-3 focus:outline-none focus:ring-2 focus:ring-blue-500">
                </div>
                
                <div>
                    <label class="block text-gray-700 font-semibold mb-2">é–‹å§‹æ—¥æœŸ</label>
                    <input type="date" id="tripStartDate" class="w-full border border-gray-300 rounded-lg px-4 py-3 focus:outline-none focus:ring-2 focus:ring-blue-500">
                </div>
                
                <button onclick="createTrip()" class="w-full bg-blue-500 hover:bg-blue-600 text-white font-semibold py-3 px-6 rounded-lg transition">
                    å»ºç«‹è¡Œç¨‹
                </button>
            </div>
        </div>
    </div>

    <!-- è¡Œç¨‹ç·¨è¼¯é  -->
    <div id="editPage" class="page">
        <div class="gradient-bg text-white py-6 px-4">
            <div class="max-w-4xl mx-auto">
                <button onclick="showList()" class="text-white mb-4">â† è¿”å›åˆ—è¡¨</button>
                <h2 id="editTripTitle" class="text-2xl font-bold mb-2"></h2>
                <p id="editTripDate" class="text-blue-100"></p>
            </div>
        </div>
        
        <div class="max-w-4xl mx-auto px-4 py-8">
            <div class="mb-6 flex gap-3 overflow-x-auto pb-2">
                <button onclick="generateTripImage()" class="bg-green-500 hover:bg-green-600 text-white font-semibold py-2 px-6 rounded-lg whitespace-nowrap transition">
                    ğŸ“· ç”Ÿæˆè¡Œç¨‹åœ–
                </button>
                <button onclick="deleteCurrentTrip()" class="bg-red-500 hover:bg-red-600 text-white font-semibold py-2 px-6 rounded-lg whitespace-nowrap transition">
                    ğŸ—‘ï¸ åˆªé™¤è¡Œç¨‹
                </button>
            </div>
            
            <div id="daysContainer" class="space-y-6">
                <!-- æ¯æ—¥è¡Œç¨‹æœƒé¡¯ç¤ºåœ¨é€™è£¡ -->
            </div>
        </div>
    </div>

    <!-- åœ–ç‰‡ç”Ÿæˆé è¦½é  -->
    <div id="previewPage" class="page">
        <div class="bg-white py-6 px-4 shadow">
            <div class="max-w-4xl mx-auto flex justify-between items-center">
                <button onclick="showEdit()" class="text-blue-500">â† è¿”å›ç·¨è¼¯</button>
                <button onclick="downloadImage()" class="bg-blue-500 hover:bg-blue-600 text-white font-semibold py-2 px-6 rounded-lg transition">
                    ğŸ’¾ ä¸‹è¼‰åœ–ç‰‡
                </button>
            </div>
        </div>
        
        <div class="py-8 bg-gray-100">
            <div id="capture-area">
                <!-- ç”Ÿæˆçš„åœ–ç‰‡å…§å®¹æœƒé¡¯ç¤ºåœ¨é€™è£¡ -->
            </div>
        </div>
    </div>

    <script>
        // è¨»å†Š Service Worker (è®“ APP å¯ä»¥é›¢ç·šä½¿ç”¨)
        if ('serviceWorker' in navigator) {
            window.addEventListener('load', () => {
                navigator.serviceWorker.register('./service-worker.js')
                    .then((registration) => {
                        console.log('Service Worker è¨»å†ŠæˆåŠŸ:', registration.scope);
                    })
                    .catch((error) => {
                        console.log('Service Worker è¨»å†Šå¤±æ•—:', error);
                    });
            });
        }

        // å…¨åŸŸè®Šæ•¸
        let trips = JSON.parse(localStorage.getItem('trips') || '[]');
        let currentTripId = null;

        // åˆå§‹åŒ–
        function init() {
            renderTripsList();
            // è¨­å®šä»Šå¤©çš„æ—¥æœŸç‚ºé è¨­å€¼
            document.getElementById('tripStartDate').valueAsDate = new Date();
        }

        // é¡¯ç¤ºä¸åŒé é¢
        function showList() {
            document.querySelectorAll('.page').forEach(p => p.classList.remove('active'));
            document.getElementById('listPage').classList.add('active');
            renderTripsList();
        }

        function showCreateTrip() {
            document.querySelectorAll('.page').forEach(p => p.classList.remove('active'));
            document.getElementById('createPage').classList.add('active');
        }

        function showEdit() {
            document.querySelectorAll('.page').forEach(p => p.classList.remove('active'));
            document.getElementById('editPage').classList.add('active');
        }

        function showPreview() {
            document.querySelectorAll('.page').forEach(p => p.classList.remove('active'));
            document.getElementById('previewPage').classList.add('active');
        }

        // å»ºç«‹æ–°è¡Œç¨‹
        function createTrip() {
            const title = document.getElementById('tripTitle').value;
            const days = parseInt(document.getElementById('tripDays').value);
            const startDate = document.getElementById('tripStartDate').value;

            if (!title || !days || !startDate) {
                alert('è«‹å¡«å¯«æ‰€æœ‰æ¬„ä½ï¼');
                return;
            }

            const trip = {
                id: Date.now(),
                title: title,
                days: days,
                startDate: startDate,
                items: Array.from({ length: days }, (_, i) => ({
                    day: i + 1,
                    date: getDateString(startDate, i),
                    places: []
                }))
            };

            trips.push(trip);
            saveTrips();
            
            // æ¸…ç©ºè¡¨å–®
            document.getElementById('tripTitle').value = '';
            document.getElementById('tripDays').value = '3';
            
            showList();
        }

        // è¨ˆç®—æ—¥æœŸ
        function getDateString(startDate, daysToAdd) {
            const date = new Date(startDate);
            date.setDate(date.getDate() + daysToAdd);
            return date.toLocaleDateString('zh-TW', { month: 'numeric', day: 'numeric', weekday: 'short' });
        }

        // æ¸²æŸ“è¡Œç¨‹åˆ—è¡¨
        function renderTripsList() {
            const container = document.getElementById('tripsList');
            
            if (trips.length === 0) {
                container.innerHTML = `
                    <div class="text-center py-12 text-gray-500">
                        <div class="text-6xl mb-4">âœˆï¸</div>
                        <p class="text-lg">é‚„æ²’æœ‰ä»»ä½•è¡Œç¨‹</p>
                        <p>é»æ“Šä¸Šæ–¹æŒ‰éˆ•å»ºç«‹ä½ çš„ç¬¬ä¸€å€‹æ—…è¡Œè¨ˆç•«ï¼</p>
                    </div>
                `;
                return;
            }

            container.innerHTML = trips.map(trip => `
                <div class="bg-white rounded-lg shadow-md p-6 hover:shadow-lg transition cursor-pointer" onclick="editTrip(${trip.id})">
                    <div class="flex justify-between items-start">
                        <div>
                            <h3 class="text-xl font-bold text-gray-800 mb-2">${trip.title}</h3>
                            <p class="text-gray-600">ğŸ“… ${trip.startDate} Â· ${trip.days} å¤©</p>
                            <p class="text-gray-500 text-sm mt-2">å…± ${trip.items.reduce((sum, day) => sum + day.places.length, 0)} å€‹æ™¯é»</p>
                        </div>
                        <div class="text-3xl">ğŸ—ºï¸</div>
                    </div>
                </div>
            `).join('');
        }

        // ç·¨è¼¯è¡Œç¨‹
        function editTrip(tripId) {
            currentTripId = tripId;
            const trip = trips.find(t => t.id === tripId);
            
            document.getElementById('editTripTitle').textContent = trip.title;
            document.getElementById('editTripDate').textContent = `${trip.startDate} Â· ${trip.days} å¤©`;
            
            renderDays(trip);
            showEdit();
        }

        // æ¸²æŸ“æ¯æ—¥è¡Œç¨‹
        function renderDays(trip) {
            const container = document.getElementById('daysContainer');
            
            container.innerHTML = trip.items.map((day, index) => `
                <div class="bg-white rounded-lg shadow-md p-6">
                    <div class="flex justify-between items-center mb-4">
                        <h3 class="text-xl font-bold text-gray-800">Day ${day.day} - ${day.date}</h3>
                        <button onclick="addPlace(${index})" class="bg-blue-500 hover:bg-blue-600 text-white px-4 py-2 rounded-lg text-sm transition">
                            â• æ–°å¢åœ°é»
                        </button>
                    </div>
                    
                    <div class="space-y-3" id="day-${index}-places">
                        ${day.places.length === 0 ? 
                            '<p class="text-gray-400 text-center py-8">å°šæœªæ–°å¢ä»»ä½•åœ°é»</p>' :
                            day.places.map((place, pIndex) => `
                                <div class="timeline-item">
                                    <div class="timeline-dot"></div>
                                    <div class="place-card bg-gray-50 rounded-lg p-4">
                                        <div class="flex justify-between items-start mb-2">
                                            <div class="flex items-center gap-2">
                                                <span class="text-2xl">${place.icon}</span>
                                                <div>
                                                    <div class="font-semibold text-gray-800">${place.name}</div>
                                                    <div class="text-sm text-gray-500">â° ${place.time}</div>
                                                </div>
                                            </div>
                                            <button onclick="deletePlace(${index}, ${pIndex})" class="text-red-500 hover:text-red-700 text-sm">
                                                ğŸ—‘ï¸
                                            </button>
                                        </div>
                                        ${place.notes ? `<p class="text-sm text-gray-600 mt-2">${place.notes}</p>` : ''}
                                    </div>
                                </div>
                            `).join('')
                        }
                    </div>
                </div>
            `).join('');
        }

        // æ–°å¢åœ°é»
        function addPlace(dayIndex) {
            const trip = trips.find(t => t.id === currentTripId);
            
            const name = prompt('åœ°é»åç¨±ï¼š');
            if (!name) return;
            
            const time = prompt('æ™‚é–“ï¼ˆä¾‹å¦‚ï¼š09:00ï¼‰ï¼š');
            if (!time) return;
            
            const typeEmoji = {
                '1': 'ğŸ›ï¸',
                '2': 'ğŸœ',
                '3': 'â˜•',
                '4': 'ğŸ¨',
                '5': 'ğŸ›ï¸'
            };
            
            const type = prompt('é¡å‹ï¼š\n1-æ™¯é» 2-é¤å»³ 3-å’–å•¡å»³ 4-ä½å®¿ 5-è³¼ç‰©\nè«‹è¼¸å…¥æ•¸å­—ï¼š');
            const icon = typeEmoji[type] || 'ğŸ“';
            
            const notes = prompt('å‚™è¨»ï¼ˆå¯ä¸å¡«ï¼‰ï¼š') || '';
            
            const place = {
                name: name,
                time: time,
                icon: icon,
                notes: notes
            };
            
            trip.items[dayIndex].places.push(place);
            saveTrips();
            renderDays(trip);
        }

        // åˆªé™¤åœ°é»
        function deletePlace(dayIndex, placeIndex) {
            if (!confirm('ç¢ºå®šè¦åˆªé™¤é€™å€‹åœ°é»å—ï¼Ÿ')) return;
            
            const trip = trips.find(t => t.id === currentTripId);
            trip.items[dayIndex].places.splice(placeIndex, 1);
            saveTrips();
            renderDays(trip);
        }

        // åˆªé™¤è¡Œç¨‹
        function deleteCurrentTrip() {
            if (!confirm('ç¢ºå®šè¦åˆªé™¤æ•´å€‹è¡Œç¨‹å—ï¼Ÿæ­¤æ“ä½œç„¡æ³•å¾©åŸï¼')) return;
            
            trips = trips.filter(t => t.id !== currentTripId);
            saveTrips();
            showList();
        }

        // ç”Ÿæˆè¡Œç¨‹åœ–ç‰‡
        function generateTripImage() {
            const trip = trips.find(t => t.id === currentTripId);
            
            const captureArea = document.getElementById('capture-area');
            captureArea.innerHTML = `
                <div class="text-center mb-6">
                    <h1 class="text-3xl font-bold text-gray-800 mb-2">${trip.title}</h1>
                    <p class="text-gray-600">ğŸ“… ${trip.startDate} Â· ${trip.days} å¤©è¡Œç¨‹</p>
                </div>
                
                ${trip.items.map(day => `
                    <div class="mb-8">
                        <div class="bg-gradient-to-r from-blue-500 to-purple-600 text-white px-4 py-3 rounded-t-lg">
                            <h3 class="text-lg font-bold">Day ${day.day} - ${day.date}</h3>
                        </div>
                        <div class="border border-gray-200 rounded-b-lg p-4 space-y-3">
                            ${day.places.length === 0 ? 
                                '<p class="text-gray-400 text-center py-4">å°šæœªè¦åŠƒ</p>' :
                                day.places.map(place => `
                                    <div class="flex items-start gap-3 bg-gray-50 p-3 rounded-lg">
                                        <span class="text-2xl">${place.icon}</span>
                                        <div class="flex-1">
                                            <div class="font-semibold text-gray-800">${place.name}</div>
                                            <div class="text-sm text-gray-500">â° ${place.time}</div>
                                            ${place.notes ? `<div class="text-sm text-gray-600 mt-1">${place.notes}</div>` : ''}
                                        </div>
                                    </div>
                                `).join('')
                            }
                        </div>
                    </div>
                `).join('')}
                
                <div class="text-center text-gray-400 text-sm mt-8">
                    Created with æ—…éŠè¡Œç¨‹è¦åŠƒ APP
                </div>
            `;
            
            showPreview();
        }

        // ä¸‹è¼‰åœ–ç‰‡
        function downloadImage() {
            const captureArea = document.getElementById('capture-area');
            
            html2canvas(captureArea, {
                backgroundColor: '#ffffff',
                scale: 2
            }).then(canvas => {
                const link = document.createElement('a');
                const trip = trips.find(t => t.id === currentTripId);
                link.download = `${trip.title}.png`;
                link.href = canvas.toDataURL('image/png');
                link.click();
            });
        }

        // å„²å­˜åˆ° localStorage
        function saveTrips() {
            localStorage.setItem('trips', JSON.stringify(trips));
        }

        // åˆå§‹åŒ–æ‡‰ç”¨
        init();
    </script>

</body>
</html>
